<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iAscendAi Dashboard | Jamaica We Rise</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --jamaica-green: #009b3a;
      --jamaica-gold: #fed100;
      --jamaica-black: #000000;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-light: #ffffff;
      --text-dark: #333333;
      --accent-blue: #1e90ff;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--text-light);
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid var(--glass-border);
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(90deg, var(--jamaica-gold), #ffe55c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header .tagline {
      font-size: 1.1em;
      opacity: 0.9;
      font-style: italic;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 15px 25px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 2px solid var(--glass-border);
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1em;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .tab.active {
      background: var(--jamaica-gold);
      color: var(--jamaica-black);
      border-color: var(--jamaica-gold);
      font-weight: bold;
    }

    .content {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 40px;
      min-height: 500px;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .soulmark-display {
      background: rgba(0, 0, 0, 0.3);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: 2px solid var(--jamaica-gold);
    }

    .soulmark-hash {
      font-family: "Courier New", monospace;
      font-size: 1.2em;
      word-break: break-all;
      color: var(--jamaica-gold);
      margin: 15px 0;
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
    }

    .identity-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .info-card {
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid var(--jamaica-gold);
    }

    .info-card label {
      font-size: 0.9em;
      opacity: 0.8;
      display: block;
      margin-bottom: 5px;
    }

    .info-card value {
      font-size: 1.2em;
      font-weight: bold;
    }

    .donation-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .donation-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 25px;
      border-radius: 15px;
      border-left: 5px solid var(--jamaica-gold);
      transition: all 0.3s ease;
    }

    .donation-item:hover {
      transform: translateX(5px);
      background: rgba(0, 0, 0, 0.4);
    }

    .donation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .donation-amount {
      font-size: 2em;
      color: var(--jamaica-gold);
      font-weight: bold;
    }

    .donation-date {
      opacity: 0.7;
      font-size: 0.9em;
    }

    .donation-impact {
      margin-top: 15px;
      padding: 15px;
      background: rgba(30, 144, 255, 0.1);
      border-radius: 10px;
      border-left: 3px solid var(--accent-blue);
    }

    .tracker-container {
      background: rgba(0, 0, 0, 0.3);
      padding: 30px;
      border-radius: 15px;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: rgba(0, 0, 0, 0.4);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid var(--jamaica-gold);
    }

    .metric-value {
      font-size: 2.5em;
      color: var(--jamaica-gold);
      font-weight: bold;
      display: block;
      margin: 10px 0;
    }

    .metric-label {
      font-size: 1em;
      opacity: 0.8;
    }

    .map-placeholder {
      background: rgba(0, 0, 0, 0.2);
      height: 400px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px dashed rgba(255, 255, 255, 0.3);
    }

    .updates-feed {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .update-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 25px;
      border-radius: 15px;
      border-left: 5px solid var(--accent-blue);
    }

    .update-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .update-title {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--jamaica-gold);
    }

    .update-date {
      opacity: 0.7;
      font-size: 0.9em;
    }

    .update-body {
      line-height: 1.6;
      margin-top: 10px;
    }

    .settings-section {
      background: rgba(0, 0, 0, 0.3);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .settings-section h3 {
      margin-bottom: 20px;
      color: var(--jamaica-gold);
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .toggle {
      position: relative;
      width: 60px;
      height: 30px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle.active {
      background: var(--jamaica-gold);
    }

    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle.active .toggle-slider {
      transform: translateX(30px);
    }

    .extend-impact {
      background: linear-gradient(135deg, var(--jamaica-gold), #ffe55c);
      color: var(--jamaica-black);
      padding: 20px 40px;
      border-radius: 15px;
      border: none;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 30px;
      display: none;
    }

    .extend-impact:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(254, 209, 0, 0.4);
    }

    .extend-impact.show {
      display: inline-block;
      animation: slideInUp 0.5s ease;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      opacity: 0.7;
    }

    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2em;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid var(--jamaica-gold);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      background: var(--jamaica-green);
      color: white;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8em;
      }

      .tabs {
        gap: 5px;
      }

      .tab {
        padding: 10px 15px;
        font-size: 0.9em;
      }

      .content {
        padding: 20px;
      }

      .donation-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üáØüá≤ iAscendAi Dashboard</h1>
      <p class="tagline">Your Verified Presence in Jamaica We Rise</p>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="soulmark">
        <span>üí†</span>
        <span>My SoulMark‚ìà</span>
      </div>
      <div class="tab" data-tab="soulaid">
        <span>üíõ</span>
        <span>My SoulAid‚ìà</span>
      </div>
      <div class="tab" data-tab="tracker">
        <span>üåç</span>
        <span>SoulTracker‚ìà</span>
      </div>
      <div class="tab" data-tab="updates">
        <span>‚úâÔ∏è</span>
        <span>Updates</span>
      </div>
      <div class="tab" data-tab="settings">
        <span>‚öôÔ∏è</span>
        <span>Settings</span>
      </div>
    </div>

    <div class="content">
      <!-- SoulMark Tab -->
      <div class="tab-content active" id="soulmark">
        <h2>üí† Your SoulMark‚ìà Identity</h2>
        <div class="soulmark-display">
          <p>
            <strong>Status:</strong>
            <span class="status-badge">‚úì VERIFIED</span>
          </p>
          <p style="margin-top: 15px;"><strong>SoulMark‚ìà Hash:</strong></p>
          <div class="soulmark-hash" id="soulmark-hash">Loading...</div>
          <p style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">
            This cryptographic signature verifies your authenticated presence in the Jamaica We Rise movement.
          </p>
        </div>

        <div class="identity-info">
          <div class="info-card">
            <label>Registered Email</label>
            <value id="user-email">Loading...</value>
          </div>
          <div class="info-card">
            <label>Username</label>
            <value id="user-username">Loading...</value>
          </div>
          <div class="info-card">
            <label>Identity Type</label>
            <value id="identity-type">Supporter‚ìà</value>
          </div>
          <div class="info-card">
            <label>Registration Date</label>
            <value id="reg-date">Loading...</value>
          </div>
        </div>

        <div
          style="
            margin-top: 30px;
            padding: 20px;
            background: rgba(30, 144, 255, 0.1);
            border-radius: 15px;
            border-left: 4px solid var(--accent-blue);
          "
        >
          <h3 style="color: var(--accent-blue); margin-bottom: 10px;">What is a SoulMark‚ìà?</h3>
          <p style="line-height: 1.6;">
            Your SoulMark‚ìà is a cryptographic verification of your participation in the Jamaica We Rise movement.
            It enables transparent tracking of your contributions while maintaining your privacy and sovereignty.
            Every action you take is verified and recorded in the public registry, creating an immutable record of impact.
          </p>
        </div>
      </div>

      <!-- SoulAid Tab -->
      <div class="tab-content" id="soulaid">
        <h2>üíõ Your SoulAid‚ìà Contributions</h2>
        <div id="donations-container" class="loading">
          <div class="spinner"></div>
          <p>Loading your contribution history...</p>
        </div>

        <button class="extend-impact" id="extend-impact-btn">
          Would you like to extend your SoulAid‚ìà impact?
        </button>
      </div>

      <!-- Tracker Tab -->
      <div class="tab-content" id="tracker">
        <h2>üåç Live SoulTracker‚ìà</h2>
        <div class="tracker-container">
          <div class="metrics">
            <div class="metric-card">
              <div class="metric-label">Total Supporters‚ìà</div>
              <span class="metric-value" id="total-supporters">0</span>
            </div>
            <div class="metric-card">
              <div class="metric-label">SoulAid‚ìà Delivered</div>
              <span class="metric-value" id="total-soulaid">$0</span>
            </div>
            <div class="metric-card">
              <div class="metric-label">Verified Survivors‚ìà</div>
              <span class="metric-value" id="total-survivors">0</span>
            </div>
            <div class="metric-card">
              <div class="metric-label">Active Parishes</div>
              <span class="metric-value" id="active-parishes">0</span>
            </div>
          </div>

          <div class="map-placeholder">
            <div style="text-align: center;">
              <div style="font-size: 3em; margin-bottom: 10px;">üó∫Ô∏è</div>
              <p>Parish-level impact map coming soon</p>
              <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
                Real-time visualization of SoulAid‚ìà distribution across Jamaica
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Updates Tab -->
      <div class="tab-content" id="updates">
        <h2>‚úâÔ∏è Field Updates</h2>
        <div class="updates-feed">
          <div class="update-item">
            <div class="update-header">
              <div class="update-title">Welcome to Jamaica We Rise</div>
              <div class="update-date">Nov 11, 2025</div>
            </div>
            <div class="update-body">
              Your SoulMark‚ìà has been verified and your presence is now part of the living system.
              Check back here for updates from field coordinators as we deploy SoulAid‚ìà to verified survivors
              across affected parishes. Every contribution is tracked transparently through the SoulTracker‚ìà.
            </div>
          </div>

          <div class="update-item">
            <div class="update-header">
              <div class="update-title">Hurricane Melissa Response Active</div>
              <div class="update-date">Nov 10, 2025</div>
            </div>
            <div class="update-body">
              FirstAidAI coordination nodes are being deployed across pilot parishes. Your contributions
              are helping establish the infrastructure that will coordinate relief with zero waste and full transparency.
              This is the beginning of Jamaica's Smart Country transformation.
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-content" id="settings">
        <h2>‚öôÔ∏è Settings & Preferences</h2>

        <div class="settings-section">
          <h3>Communication Preferences</h3>
          <div class="setting-item">
            <div>
              <strong>Field Updates</strong>
              <p style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">
                Receive updates when your SoulAid‚ìà is deployed
              </p>
            </div>
            <div class="toggle active" data-setting="updates">
              <div class="toggle-slider"></div>
            </div>
          </div>
          <div class="setting-item">
            <div>
              <strong>Impact Reports</strong>
              <p style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">
                Monthly summaries of movement progress
              </p>
            </div>
            <div class="toggle active" data-setting="reports">
              <div class="toggle-slider"></div>
            </div>
          </div>
          <div class="setting-item">
            <div>
              <strong>SoulTracker‚ìà Notifications</strong>
              <p style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">
                Real-time alerts for major milestones
              </p>
            </div>
            <div class="toggle" data-setting="notifications">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>Privacy & Data</h3>
          <div class="setting-item">
            <div>
              <strong>Public Registry Visibility</strong>
              <p style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">
                Show your contributions in the public ledger
              </p>
            </div>
            <div class="toggle active" data-setting="public">
              <div class="toggle-slider"></div>
            </div>
          </div>
          <div class="setting-item">
            <div>
              <strong>Display Username</strong>
              <p style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">
                Show username instead of anonymous SoulMark‚ìà
              </p>
            </div>
            <div class="toggle active" data-setting="username-display">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>Account Information</h3>
          <p style="opacity: 0.8; line-height: 1.6;">
            Your SoulMark‚ìà identity is cryptographically secured and stored locally on your device.
            All contributions are recorded in the immutable public registry. To update your email or
            username, please contact support at support@iascendai.com.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://jamaica-we-rise.onrender.com";

    // State management
    let userData = {
      soulmark: "",
      email: "",
      username: "",
      role: "supporter",
      donations: [],
      registrationDate: "",
      presenceTime: 0,
      hasInteracted: false,
    };

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);

      // Pull from URL or localStorage
      userData.soulmark =
        params.get("soulmark") || localStorage.getItem("soulmark") || "";
      userData.email =
        params.get("email") || localStorage.getItem("email") || "";
      userData.username =
        params.get("username") || localStorage.getItem("username") || "";

      if (params.get("role")) {
        userData.role = params.get("role");
      }

      // Persist
      if (userData.soulmark) localStorage.setItem("soulmark", userData.soulmark);
      if (userData.email) localStorage.setItem("email", userData.email);
      if (userData.username) localStorage.setItem("username", userData.username);

      // Show quick identity info immediately
      document.getElementById("soulmark-hash").textContent =
        userData.soulmark || "Not available";
      document.getElementById("user-email").textContent =
        userData.email || "Not registered";
      document.getElementById("user-username").textContent =
        userData.username || "Anonymous";
      document.getElementById("identity-type").textContent =
        userData.role === "survivor" ? "Survivor‚ìà" : "Supporter‚ìà";

      await loadUserData();
      initTabs();
      initToggles();
      startPresenceTracking();
      loadTrackerMetrics();
    });

    // Load user data from registry
    async function loadUserData() {
      try {
        const response = await fetch(`${BACKEND_URL}/registry`, {
          cache: "no-store",
        });
        const registry = await response.json();

        // Find all entries related to this user
        const relatedEntries = registry.filter((entry) => {
          const eEmail = (entry.email || "").toLowerCase();
          const eSoul = (entry.soulmark || entry.soulMark || "").toUpperCase();
          const eUser = (entry.username || "").toLowerCase();

          return (
            (userData.email && eEmail === userData.email.toLowerCase()) ||
            (userData.soulmark &&
              eSoul === userData.soulmark.toUpperCase()) ||
            (userData.username && eUser === userData.username.toLowerCase())
          );
        });

        // Separate identity-style entries (with username/role) from raw donations
        const identityEntries = relatedEntries.filter(
          (e) => e.username || e.role
        );
        const donationEntries = relatedEntries.filter(
          (e) => typeof e.amount === "number"
        );

        // Pick primary identity
        let identity = identityEntries[0] || relatedEntries[0] || null;

        if (identity) {
          if (identity.soulmark || identity.soulMark) {
            userData.soulmark = identity.soulmark || identity.soulMark;
            document.getElementById("soulmark-hash").textContent =
              userData.soulmark;
          }
          if (identity.email) {
            userData.email = identity.email;
            document.getElementById("user-email").textContent = identity.email;
          }
          if (identity.username) {
            userData.username = identity.username;
            document.getElementById(
              "user-username"
            ).textContent = `${identity.username}@iascendai`;
          } else if (userData.username) {
            document.getElementById(
              "user-username"
            ).textContent = `${userData.username}@iascendai`;
          }

          if (identity.role) {
            userData.role = identity.role;
            document.getElementById("identity-type").textContent =
              identity.role === "survivor" ? "Survivor‚ìà" : "Supporter‚ìà";
          }

          // Registration date: prefer createdAt, then timestamp
          const regDateRaw =
            identity.createdAt ||
            identity.timestamp ||
            identity.date ||
            new Date().toISOString();
          userData.registrationDate = new Date(regDateRaw).toLocaleDateString(
            "en-US",
            {
              year: "numeric",
              month: "long",
              day: "numeric",
            }
          );
        } else {
          userData.registrationDate = new Date().toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        }

        document.getElementById("reg-date").textContent =
          userData.registrationDate;

        // Save donations
        userData.donations = donationEntries;
        renderDonations();
      } catch (error) {
        console.error("Error loading user data:", error);
        document.getElementById("donations-container").innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <p>Unable to load donation history</p>
            <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
              Please check your connection and try again
            </p>
          </div>
        `;
      }
    }

    // Render donations list
    function renderDonations() {
      const container = document.getElementById("donations-container");

      if (!userData.donations || userData.donations.length === 0) {
        container.className = "donation-list";
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üíõ</div>
            <p>No SoulAid‚ìà contributions yet</p>
            <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
              Your verified contributions will appear here after your first donation.
            </p>
          </div>
        `;
        return;
      }

      container.className = "donation-list";
      container.innerHTML = userData.donations
        .map((donation) => {
          const dateRaw =
            donation.createdAt || donation.timestamp || donation.date;
          const date = dateRaw
            ? new Date(dateRaw).toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            : "Date not available";

          const txId = donation.transactionId || donation.sessionId || "Pending";

          return `
          <div class="donation-item">
            <div class="donation-header">
              <div class="donation-amount">$${donation.amount}</div>
              <div class="donation-date">${date}</div>
            </div>
            <div>
              <strong>Transaction ID:</strong> ${txId}
            </div>
            <div class="donation-impact">
              <strong>üåç Impact Status:</strong><br>
              Your SoulAid‚ìà contribution is being coordinated through FirstAidAI for distribution
              to verified survivors in affected parishes. Check the SoulTracker‚ìà for live updates.
            </div>
          </div>
        `;
        })
        .join("");
    }

    // Tab navigation
    function initTabs() {
      const tabs = document.querySelectorAll(".tab");
      const contents = document.querySelectorAll(".tab-content");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          userData.hasInteracted = true;

          tabs.forEach((t) => t.classList.remove("active"));
          contents.forEach((c) => c.classList.remove("active"));

          tab.classList.add("active");
          const targetId = tab.dataset.tab;
          document.getElementById(targetId).classList.add("active");
        });
      });
    }

    // Toggle switches
    function initToggles() {
      const toggles = document.querySelectorAll(".toggle");

      toggles.forEach((toggle) => {
        const setting = toggle.dataset.setting;
        const saved = localStorage.getItem(`setting_${setting}`);
        if (saved === "true") {
          toggle.classList.add("active");
        } else if (saved === "false") {
          toggle.classList.remove("active");
        }

        toggle.addEventListener("click", () => {
          toggle.classList.toggle("active");
          const isActive = toggle.classList.contains("active");
          localStorage.setItem(`setting_${setting}`, isActive);
        });
      });
    }

    // Presence tracking for "extend impact" logic
    function startPresenceTracking() {
      setInterval(() => {
        userData.presenceTime += 1;

        if (
          userData.presenceTime >= 120 &&
          userData.hasInteracted &&
          userData.donations.length > 0
        ) {
          document
            .getElementById("extend-impact-btn")
            .classList.add("show");
        }
      }, 1000);
    }

    // Handle extend impact button
    document
      .getElementById("extend-impact-btn")
      .addEventListener("click", () => {
        const params = new URLSearchParams();
        if (userData.email) params.set("email", userData.email);
        if (userData.soulmark) params.set("soulmark", userData.soulmark);
        if (userData.username) params.set("username", userData.username);
        params.set("returning", "true");
        window.location.href = `/donate.html?${params.toString()}`;
      });

    // Load tracker metrics using /registry
    async function loadTrackerMetrics() {
      try {
        const response = await fetch(`${BACKEND_URL}/registry`, {
          cache: "no-store",
        });
        const registry = await response.json();

        const supporterEmails = new Set();
        let totalSoulaid = 0;
        let survivorCount = 0;

        registry.forEach((entry) => {
          if (entry.email) supporterEmails.add(entry.email);
          if (typeof entry.amount === "number") {
            totalSoulaid += entry.amount;
          }
          if (entry.role === "survivor") survivorCount += 1;
        });

        document.getElementById("total-supporters").textContent =
          supporterEmails.size;
        document.getElementById(
          "total-soulaid"
        ).textContent = `$${totalSoulaid.toLocaleString()}`;
        document.getElementById("total-survivors").textContent =
          survivorCount;
        // For now, active parishes is a static pilot value
        document.getElementById("active-parishes").textContent = 3;
      } catch (error) {
        console.error("Error loading tracker metrics:", error);
      }
    }
  </script>
</body>
</html>
