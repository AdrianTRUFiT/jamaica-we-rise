<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Dashboard | Jamaica We Rise Ã— iAscendAi</title>

  <script type="module">
    import { CONFIG } from "./config.js";
    window.CONFIG = CONFIG;
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827 0%, #020617 45%, #000000 100%);
      color: #e5e7eb;
      padding: 24px 16px 32px;
    }

    .shell {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 18px;
    }

    .title {
      font-size: 1.7rem;
      font-weight: 800;
      color: #a5f3fc;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .nav-row {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .nav-link {
      font-size: 0.85rem;
      color: #facc15;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(250,204,21,0.3);
      background: rgba(15,23,42,0.85);
    }

    .nav-link:hover {
      background: rgba(250,204,21,0.08);
    }

    .status-text {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .card-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .card-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 16px 16px 14px;
    }

    .card h2 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .value {
      font-size: 0.98rem;
      font-weight: 600;
      margin-bottom: 10px;
      word-break: break-all;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      border-radius: 999px;
      font-size: 0.78rem;
      margin-bottom: 8px;
    }

    .status-ok {
      background: rgba(22,163,74,0.14);
      border: 1px solid rgba(34,197,94,0.7);
      color: #bbf7d0;
    }

    .status-pending {
      background: rgba(234,179,8,0.14);
      border: 1px solid rgba(250,204,21,0.7);
      color: #facc15;
    }

    .muted {
      color: #9ca3af;
      font-size: 0.84rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.82rem;
    }

    th, td {
      text-align: left;
      padding: 6px 4px;
      border-bottom: 1px solid rgba(55,65,81,0.8);
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    footer {
      margin-top: 22px;
      font-size: 0.78rem;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <div class="title">Your Dashboard</div>
      <div class="subtitle">SoulMarkâ“ˆ Identity Â· Verified Contribution</div>

      <div class="nav-row">
        <a class="nav-link" href="impact-dashboard.html">Impact Dashboard</a>
        <a class="nav-link" href="soulregistry.html">SoulRegistryâ“ˆ Directory</a>
        <a class="nav-link" href="iascendai-verify.html">Verify Identity</a>
        <a class="nav-link" href="index.html">Donate Again</a>
      </div>

      <div id="statusText" class="status-text">Loading your verified recordâ€¦</div>
    </header>

    <section class="card-grid">
      <article class="card" id="identityCard">
        <h2>Your SoulMarkâ“ˆ Identity</h2>
        <div id="identityStatusPill" class="status-pill status-pending">
          <span>Pending</span>
        </div>

        <div class="label">SoulMarkâ“ˆ Hash</div>
        <div id="soulValue" class="value">Loadingâ€¦</div>

        <div class="label">Name</div>
        <div id="nameValue" class="value">â€”</div>

        <div class="label">Username</div>
        <div id="usernameValue" class="value">â€”</div>

        <div class="label">Identity Type</div>
        <div id="roleValue" class="value">supporterâ“ˆ</div>

        <div class="muted" id="identityNote"></div>
      </article>

      <article class="card">
        <h2>Your Support Snapshot</h2>
        <div class="label">Latest Donation</div>
        <div id="latestDonation" class="value">$0.00</div>

        <div class="label">Total Contributions</div>
        <div id="totalDonations" class="value">$0.00</div>

        <div class="label">Entries Linked to You</div>
        <div id="entryCount" class="value">0</div>

        <p class="muted">
          These totals are based on verified registry records linked to your
          username, email, or SoulMarkâ“ˆ hash.
        </p>
      </article>
    </section>

    <section class="card" style="margin-top:18px;">
      <h2>Recent Activity</h2>
      <table id="activityTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Amount / Role</th>
            <th>When</th>
          </tr>
        </thead>
        <tbody id="activityBody">
          <tr><td colspan="3" class="muted">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </section>

    <footer>
      Â© 2025 Project Inside Out Jamaica Ã— iAscendAi Â· Authored Intelligence
    </footer>
  </div>

  <script>
    const BACKEND_URL = (window.CONFIG && window.CONFIG.BACKEND_URL) || "";

    const statusTextEl = document.getElementById("statusText");
    const soulValueEl = document.getElementById("soulValue");
    const nameValueEl = document.getElementById("nameValue");
    const usernameValueEl = document.getElementById("usernameValue");
    const roleValueEl = document.getElementById("roleValue");
    const identityNoteEl = document.getElementById("identityNote");
    const statusPillEl = document.getElementById("identityStatusPill");

    const latestDonationEl = document.getElementById("latestDonation");
    const totalDonationsEl = document.getElementById("totalDonations");
    const entryCountEl = document.getElementById("entryCount");
    const activityBodyEl = document.getElementById("activityBody");

    // Pull context with username as the primary anchor
    function getContext() {
      const params = new URLSearchParams(window.location.search);

      const usernameParam = (params.get("username") || "").toLowerCase();
      const soulParam = params.get("soulmark") || "";

      const storedUsername = (localStorage.getItem("username") || "").toLowerCase();
      const storedSoul = localStorage.getItem("soulmark") || "";
      const storedEmail = localStorage.getItem("email") || "";

      const displayIdentity =
        params.get("mode") ||
        localStorage.getItem("displayIdentity") ||
        "username";

      const showDonationFlag =
        params.get("showDonation") ??
        localStorage.getItem("showDonationAmount") ??
        "1";

      const showDonationAmount = showDonationFlag === "1";

      return {
        username: usernameParam || storedUsername, // PRIMARY KEY
        soulmark: soulParam || storedSoul,
        email: storedEmail,
        displayIdentity,
        showDonationAmount,
      };
    }

    async function loadDashboard() {
      const ctx = getContext();

      if (!ctx.username) {
        statusTextEl.textContent =
          "We couldnâ€™t detect a linked username. Please return to the Success page and complete registration.";
        return;
      }

      statusTextEl.textContent = "Loading your verified recordâ€¦";

      try {
        const res = await fetch(`${BACKEND_URL}/registry`);
        const registry = await res.json();

        if (!Array.isArray(registry)) {
          throw new Error("Invalid registry format");
        }

        // ðŸ” Identity is matched by USERNAME ONLY
        const identity = registry
          .filter((r) => r.type === "identity")
          .find((r) => {
            const u = (r.username || "").toLowerCase();
            return ctx.username && u === ctx.username;
          });

        // Decide which keys to use when aggregating donations
        const keyEmail = identity?.email || ctx.email || null;
        const keySoul  = identity?.soulmark || ctx.soulmark || null;

        // Donations are linked via the matched identityâ€™s email or SoulMark
        const donations = registry.filter((r) => {
          if (r.type !== "donation") return false;
          const e = r.email || "";
          const s = r.soulmark || "";
          return (
            (keyEmail && e === keyEmail) ||
            (keySoul && s === keySoul)
          );
        });

        // -------------------------
        // Identity card
        // -------------------------
        if (!identity) {
          statusTextEl.textContent =
            "No identity record found for this username yet. Your donation may be verified, but identity registration is still pending.";
          statusPillEl.classList.remove("status-ok");
          statusPillEl.classList.add("status-pending");
          statusPillEl.textContent = "Pending";

          soulValueEl.textContent = ctx.soulmark || "Assigned after verification";
          nameValueEl.textContent = "â€”";
          usernameValueEl.textContent = ctx.username
            ? `${ctx.username}@iascendai`
            : "â€”";
          identityNoteEl.textContent =
            "Once your identity is registered, your SoulMarkâ“ˆ will be linked to this username.";
        } else {
          statusTextEl.textContent = "Identity located and linked to your SoulMarkâ“ˆ.";
          statusPillEl.classList.remove("status-pending");
          statusPillEl.classList.add("status-ok");
          statusPillEl.textContent = "Verified";

          identity.displayIdentity =
            identity.displayIdentity || ctx.displayIdentity;
          identity.showDonationAmount =
            typeof identity.showDonationAmount === "boolean"
              ? identity.showDonationAmount
              : ctx.showDonationAmount;

          const chosenUsername = identity.username || ctx.username || "â€”";
          const chosenName = identity.name || "";

          if (identity.displayIdentity === "real") {
            nameValueEl.textContent = chosenName || "â€”";
            usernameValueEl.textContent = chosenUsername
              ? `${chosenUsername}@iascendai`
              : "â€”";
            identityNoteEl.textContent =
              "You chose to display your real name on the public tracker.";
          } else if (identity.displayIdentity === "anonymous") {
            nameValueEl.textContent = "Anonymous";
            usernameValueEl.textContent = "Hidden";
            identityNoteEl.textContent =
              "You chose to appear as Anonymous. Your SoulMarkâ“ˆ remains verifiable.";
          } else {
            nameValueEl.textContent = chosenName || "â€”";
            usernameValueEl.textContent = chosenUsername
              ? `${chosenUsername}@iascendai`
              : "â€”";
            identityNoteEl.textContent =
              "You chose to display your username on the public tracker.";
          }

          soulValueEl.textContent =
            identity.soulmark || ctx.soulmark || "Assigned after verification";
          roleValueEl.textContent = identity.role || "supporterâ“ˆ";
        }

        // -------------------------
        // Donation aggregation
        // -------------------------
        if (donations.length === 0) {
          latestDonationEl.textContent = "$0.00";
          totalDonationsEl.textContent = "$0.00";
          entryCountEl.textContent = identity ? "1" : "0";
          activityBodyEl.innerHTML =
            '<tr><td colspan="3" class="muted">No linked donations found yet.</td></tr>';
        } else {
          donations.sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          );

          const total = donations.reduce(
            (sum, d) => sum + (Number(d.amount) || 0),
            0
          );
          const latest = donations[0];

          latestDonationEl.textContent = `$${Number(latest.amount || 0).toFixed(
            2
          )}`;
          totalDonationsEl.textContent = `$${total.toFixed(2)}`;
          entryCountEl.textContent = String(
            donations.length + (identity ? 1 : 0)
          );

          activityBodyEl.innerHTML = "";
          const rows = [];

          donations.slice(0, 6).forEach((d) => {
            const when = d.timestamp
              ? new Date(d.timestamp).toLocaleString()
              : "â€”";
            const amt = `$${Number(d.amount || 0).toFixed(2)}`;

            rows.push(
              `<tr>
                 <td>Donation</td>
                 <td>${amt}</td>
                 <td>${when}</td>
               </tr>`
            );
          });

          if (identity) {
            const when = identity.createdAt
              ? new Date(identity.createdAt).toLocaleString()
              : "â€”";
            rows.unshift(
              `<tr>
                 <td>Identity</td>
                 <td>${identity.role || "supporter"}</td>
                 <td>${when}</td>
               </tr>`
            );
          }

          activityBodyEl.innerHTML = rows.join("");
        }
      } catch (err) {
        console.error("Dashboard load failed:", err);
        statusTextEl.textContent =
          "We couldnâ€™t load your dashboard right now. Please refresh in a moment.";
        activityBodyEl.innerHTML =
          '<tr><td colspan="3" class="muted">Error loading activity.</td></tr>';
      }
    }

    loadDashboard();
  </script>
</body>
</html>