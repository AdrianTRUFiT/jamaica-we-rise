<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Your Identity | iAscendAi</title>

  <script type="module">
    import { CONFIG } from "./config.js";
    window.CONFIG = CONFIG;
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --iascend-orange: #f4a349;
      --iascend-orange-soft: #ffb76b;
      --iascend-blue: #b8edee;
      --bg-dark: #020617;
      --glass-bg: rgba(15,23,42,0.96);
      --glass-border: rgba(148,163,184,0.45);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --error: #f97373;
      --success: #4ade80;
      --info: #38bdf8;
    }

    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont;
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f2937 0%, #020617 45%, #000000 100%);
      display: flex;
      justify-content: center;
      padding: 22px;
      color: var(--text-main);
    }

    .container {
      width: 100%;
      max-width: 640px;
      background: var(--glass-bg);
      border-radius: 24px;
      padding: 26px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 30px 80px rgba(0,0,0,0.75);
    }

    .header { text-align: center; margin-bottom: 22px; }
    .logo {
      font-size: 1.7rem; font-weight: 800;
      background: linear-gradient(120deg, var(--iascend-orange), var(--iascend-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .tagline { color: var(--text-soft); font-size: 0.95rem; }

    .pill {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.55);
      font-size: 0.8rem;
      color: #bbf7d0;
      margin-bottom: 10px;
    }

    .card-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; }
    .card-subtitle {
      font-size: 0.92rem; line-height: 1.6;
      color: var(--text-soft); margin-bottom: 16px;
    }

    .highlight-box {
      background: rgba(15,23,42,0.9);
      padding: 14px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 0.85rem;
      margin-bottom: 18px;
    }

    .form-group { margin-bottom: 16px; }
    label { font-weight: 600; font-size: 0.9rem; margin-bottom: 6px; display:block; }

    input {
      width: 100%;
      padding: 11px 13px;
      border-radius: 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.65);
      font-size: 0.95rem;
      color: var(--text-main);
    }

    .username-group { position: relative; }
    .username-suffix {
      position: absolute; right: 12px; top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem; color: var(--text-soft); font-weight: 600;
    }

    .availability { font-size: 0.8rem; margin-top: 4px; min-height: 18px; }
    .availability.ok { color: var(--success); }
    .availability.bad { color: var(--error); }
    .availability.checking { color: var(--text-soft); }

    .display-section {
      margin-top: 14px; padding: 12px;
      background: rgba(15,23,42,0.9);
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.45);
      margin-bottom: 14px;
    }

    .display-option-group { margin-top: 6px; display:flex; flex-direction:column; gap:4px; }

    .submit-btn {
      width: 100%; padding:14px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--iascend-orange), var(--iascend-orange-soft));
      border: none; font-weight: 700; font-size: 1rem;
      color: #041423; cursor: pointer;
      box-shadow: 0 18px 44px rgba(0,0,0,0.7);
    }

    .footer-links { text-align: center; margin-top: 20px; font-size:0.85rem; }
    .footer-links a {
      color: var(--iascend-orange-soft); font-weight: 600; text-decoration:none;
    }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="logo">iAscendAi</div>
    <div class="tagline">Claim your verified identity to unlock the dashboard.</div>
  </div>

  <h1 class="card-title">Create Your Identity</h1>
  <div class="pill">üéÅ Supporter‚ìà ‚Ä¢ Jamaica We Rise</div>

  <p class="card-subtitle">
    You‚Äôve made a verified contribution. Now claim your unique
    <strong>username@iascendai</strong> and access your SoulMark‚ìà, SoulAid‚ìà,
    and the SoulTracker‚ìà dashboard.
  </p>

  <div class="highlight-box">
    <strong>One entry. One identity.</strong><br>
    Every future update or contribution will be anchored to this username.
  </div>

  <form id="registrationForm">

    <div class="form-group">
      <label>Full Name *</label>
      <input id="name" placeholder="Adrian McKenzie" />
    </div>

    <div class="form-group">
      <label>Email Address *</label>
      <input id="email" type="email" placeholder="you@example.com" />
    </div>

    <div class="form-group">
      <label>Choose Your Username *</label>
      <div class="username-group">
        <input id="username" placeholder="adrian" autocomplete="off" />
        <span class="username-suffix">@iascendai</span>
      </div>
      <div id="usernameStatus" class="availability"></div>
    </div>

    <div class="display-section">
      <div class="display-option-group">
        <label><input type="radio" name="identityMode" value="username" checked /> Username@iascendai</label>
        <label><input type="radio" name="identityMode" value="real" /> Real Name</label>
        <label><input type="radio" name="identityMode" value="anonymous" /> Anonymous</label>
      </div>

      <label style="margin-top:10px;">
        <input type="checkbox" id="showDonation" checked /> Show Donation Amount
      </label>
    </div>

    <button id="submitBtn" class="submit-btn">
      Create My Identity & Open Dashboard
    </button>

  </form>

  <div class="footer-links">
    Already have a username?
    <a href="iascendai-verify.html">Verify your identity</a> ‚Ä¢
    <a href="index.html">Back to Donate</a>
  </div>

</div>

<script type="module">
  const BACKEND_URL = window.CONFIG.BACKEND_URL;

  const nameInput      = document.getElementById("name");
  const emailInput     = document.getElementById("email");
  const usernameInput  = document.getElementById("username");
  const usernameStatus = document.getElementById("usernameStatus");
  const submitBtn      = document.getElementById("submitBtn");

  const identityRadios = document.querySelectorAll('input[name="identityMode"]');
  const showDonationCb = document.getElementById("showDonation");

  let currentSoulmark = "";
  let currentAmount   = "";
  let usernameAvailable = false;
  let checkDelay = null;

  // -------------------------
  // HYDRATE FROM SUCCESS PAGE
  // -------------------------
  (function hydrate() {
    const p = new URLSearchParams(window.location.search);

    const qsEmail = p.get("email") || "";
    const qsSoul  = p.get("soulmark") || "";
    const qsAmt   = p.get("amount") || "";

    const lsEmail = localStorage.getItem("email") || "";
    const donorEmail = localStorage.getItem("donor_email") || "";

    const email = qsEmail || donorEmail || lsEmail;

    if (email) emailInput.value = email;

    currentSoulmark = qsSoul || localStorage.getItem("soulmark") || "";
    currentAmount   = qsAmt  || localStorage.getItem("donationAmount") || "";

    if (currentSoulmark) localStorage.setItem("soulmark", currentSoulmark);
    if (currentAmount)   localStorage.setItem("donationAmount", currentAmount);
    if (email)           localStorage.setItem("email", email);
  })();

  // -------------------------
  // CHECK USERNAME
  // -------------------------
  usernameInput.addEventListener("input", () => {
    const raw = usernameInput.value.trim().toLowerCase();
    const username = raw.replace(/[^a-z0-9._-]/g, "");
    usernameInput.value = username;

    usernameStatus.textContent = "";
    usernameStatus.className = "availability";
    usernameAvailable = false;

    if (username.length < 3) return;

    usernameStatus.textContent = "Checking availability‚Ä¶";
    usernameStatus.classList.add("checking");

    clearTimeout(checkDelay);
    checkDelay = setTimeout(async () => {
      try {
        const res = await fetch(`${BACKEND_URL}/check-username/${username}`);
        const data = await res.json();

        if (data.available) {
          usernameAvailable = true;
          usernameStatus.textContent = "‚úì Available";
          usernameStatus.className = "availability ok";
        } else {
          usernameAvailable = false;
          usernameStatus.textContent = "‚úó Taken";
          usernameStatus.className = "availability bad";
        }
      } catch {
        usernameStatus.textContent = "Could not check. Try again.";
        usernameStatus.className = "availability bad";
      }
    }, 450);
  });

  // -------------------------
  // SUBMIT REGISTRATION
  // -------------------------
  document.getElementById("registrationForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const username = usernameInput.value.trim().toLowerCase();

    if (!name || !email || !username) {
      alert("Please fill in all required fields.");
      return;
    }

    if (!usernameAvailable) {
      alert("Please choose an available username.");
      return;
    }

    const identityMode = [...identityRadios].find(r => r.checked).value;
    const showDonation = showDonationCb.checked;

    submitBtn.textContent = "Creating Identity‚Ä¶";
    submitBtn.disabled = true;

    const payload = {
      role: "supporter",
      name,
      email,
      username,
      soulmark: currentSoulmark,
      donationAmount: Number(currentAmount) || null,
      displayIdentity: identityMode,
      showDonationAmount: showDonation
    };

    try {
      const res = await fetch(`${BACKEND_URL}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok || data.error) throw new Error(data.error);

      localStorage.setItem("username", username);
      localStorage.setItem("displayIdentity", identityMode);
      localStorage.setItem("showDonationAmount", showDonation ? "1" : "0");

      window.location.href = `iascendai-dashboard.html?username=${username}`;
    } catch (err) {
      alert(err.message || "Registration failed.");
      submitBtn.disabled = false;
      submitBtn.textContent = "Create My Identity & Open Dashboard";
    }
  });
</script>

</body>
</html>