<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donation Successful | iAscendAi</title>

  <script type="module">
    import { CONFIG } from "./config.js";
    window.CONFIG = CONFIG;
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Inter, sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
    }
    .card {
      background: rgba(15,23,42,0.9);
      padding: 32px;
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,0.45);
      width:100%;
      max-width:600px;
    }
    h1 {
      text-align:center;
      font-size:1.8rem;
      background:linear-gradient(120deg,#b8edee,#fed103);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:16px;
    }
    .label {
      color:#9ca3af;
      font-size:.78rem;
      text-transform:uppercase;
      margin-top:14px;
    }
    .value-box {
      padding:12px;
      border-radius:12px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(148,163,184,0.35);
      font-size:1rem;
      margin-top:5px;
      word-break:break-all;
    }
    button {
      width:100%;
      padding:16px;
      margin-top:30px;
      border:none;
      border-radius:999px;
      background:linear-gradient(135deg,#f4a349,#fed103);
      color:#041423;
      font-weight:700;
      cursor:pointer;
      font-size:1rem;
    }
    #errorBox {
      color:#ef4444;
      margin-top:10px;
      text-align:center;
      min-height:20px;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Donation Successful</h1>

    <p style="text-align:center;color:#9ca3af;margin-bottom:18px;">
      Verifying your donation and linking your identity…
    </p>

    <div class="label">Amount</div>
    <div id="amountBox" class="value-box">$—</div>

    <div class="label">Email</div>
    <div id="emailBox" class="value-box">Loading…</div>

    <div class="label">SoulMarkⓈ</div>
    <div id="soulBox" class="value-box" style="font-size:0.9rem;">Loading…</div>

    <div id="errorBox"></div>

    <button id="continueBtn">Continue to Create Your Identity</button>
  </div>

  <script type="module">
    import { CONFIG } from "./config.js";
    const BACKEND_URL = CONFIG.BACKEND_URL;

    // Stripe passes ?session_id=
    const params = new URLSearchParams(window.location.search);
    let sessionId = params.get("session_id");

    const amountBox  = document.getElementById("amountBox");
    const emailBox   = document.getElementById("emailBox");
    const soulBox    = document.getElementById("soulBox");
    const errorBox   = document.getElementById("errorBox");

    async function loadVerification() {
      try {
        const res = await fetch(`${BACKEND_URL}/verify-donation/${sessionId}`);
        const data = await res.json();

        if (!res.ok || !data.email) throw new Error("Verification failed");

        // Fill UI
        amountBox.textContent = `$${Number(data.amount).toFixed(2)}`;
        emailBox.textContent  = data.email;
        soulBox.textContent   = data.soulmark;

        // Store for register page
        localStorage.setItem("email", data.email);
        localStorage.setItem("soulmark", data.soulmark);
        localStorage.setItem("donationAmount", data.amount);

      } catch (err) {
        console.error(err);
        errorBox.textContent = "Verification failed. Please refresh.";
      }
    }

    if (sessionId) loadVerification();
    else errorBox.textContent = "Missing session ID.";

    document.getElementById("continueBtn").onclick = () => {
      const email  = localStorage.getItem("email") || "";
      const soul   = localStorage.getItem("soulmark") || "";
      const amount = localStorage.getItem("donationAmount") || "";

      window.location.href =
        `iascendai-register.html?email=${encodeURIComponent(email)}&soulmark=${encodeURIComponent(soul)}&amount=${encodeURIComponent(amount)}`;
    };
  </script>
</body>
</html>