<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SoulMarkⓈ Verification | iAscendAi</title>

<!-- Load CONFIG -->
<script type="module">
import { CONFIG } from "./config.js";
window.CONFIG = CONFIG;
</script>

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,'Inter','Segoe UI',Roboto,sans-serif;
  background:#041423;
  color:#fff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  margin:0;
  padding:20px;
  text-align:center;
}

.logout-btn {
  position: absolute;
  top: 18px;
  right: 18px;
  padding: 6px 14px;
  font-size: 0.8rem;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  color: #fff;
  cursor: pointer;
  backdrop-filter: blur(5px);
}

.page-title {
  font-size:1.1em;
  color:#f4a349;
  opacity:0.9;
  margin-bottom:10px;
}

h1 {
  background:linear-gradient(135deg,#fed103,#059c3a);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  font-size:2.4em;
  margin-bottom:20px;
}

.verify-box {
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:16px;
  padding:30px 40px;
  width:90%;
  max-width:480px;
  box-shadow:0 0 25px rgba(5,156,58,0.2);
}

input {
  width:100%;
  padding:14px;
  margin-top:10px;
  border-radius:10px;
  background:rgba(255,255,255,0.05);
  border:2px solid rgba(255,255,255,0.1);
  color:#fff;
  font-size:1em;
}

button {
  width:100%;
  margin-top:25px;
  padding:15px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#059c3a,#047d2f);
  color:#fff;
  font-weight:700;
  cursor:pointer;
}

#result {
  margin-top:20px;
  min-height:1.4em;
  white-space:pre-line;
  font-size:1em;
}

#result.verified { color:#10b981; }
#result.invalid  { color:#ef4444; }

.footer-links {
  margin-top:25px;
  display:none;
  gap:20px;
  justify-content:center;
  flex-wrap:wrap;
}

.footer-links a {
  color:#f4a349;
  font-size:0.9em;
  text-decoration:none;
}
</style>
</head>

<body>

<!-- LOGOUT -->
<button class="logout-btn" id="logoutBtn">Logout</button>

<div class="page-title">iAscendAi — Verify Digital Identities</div>
<h1>SoulMarkⓈ Verification</h1>

<div class="verify-box">
  <p>Enter a SoulMarkⓈ signature to validate an identity.</p>

  <input id="soulmarkInput" type="text" placeholder="Enter SoulMarkⓈ signature..." />
  <button id="verifyBtn">Verify SoulMarkⓈ</button>

  <div id="result"></div>
</div>

<div class="footer-links" id="footerNav">
  <a href="iascendai-register.html">Create Identity</a>
  <a href="soulregistry.html">SoulRegistryⓈ</a>
  <a id="dashboardLink" href="#">Dashboard</a>
</div>

<script type="module">
import { CONFIG } from "./config.js";
const BACKEND_URL = CONFIG.BACKEND_URL;

const resultEl = document.getElementById("result");
const footerNav = document.getElementById("footerNav");
const dashboardLink = document.getElementById("dashboardLink");

// LOGOUT → LOGIN PAGE
document.getElementById("logoutBtn").onclick = () => {
  localStorage.clear();
  window.location.href = "iascendai-login.html";
};

// VERIFY FUNCTION
document.getElementById("verifyBtn").addEventListener("click", verifySoulmark);

async function verifySoulmark() {
  const raw = document.getElementById("soulmarkInput").value.trim();
  resultEl.className = "";
  resultEl.textContent = "Verifying…";
  footerNav.style.display = "none";

  if (!raw) {
    resultEl.textContent = "Please enter your SoulMarkⓈ.";
    return;
  }

  try {
    const res = await fetch(`${BACKEND_URL}/registry`, { cache: "no-store" });
    const registry = await res.json();

    const input = raw.toLowerCase();

    // Identity match
    const identity = registry.find(
      r =>
        r.type === "identity" &&
        (r.soulmark || "").toLowerCase() === input
    );

    // Donation-only match
    const donation = registry.find(
      r =>
        r.type === "donation" &&
        (r.soulmark || "").toLowerCase() === input
    );

    // CASE A — Identity Found
    if (identity) {
      const uname = identity.username
        ? `${identity.username}@iascendai`
        : "—";

      resultEl.className = "verified";
      resultEl.textContent =
`✓ Verified SoulMarkⓈ
Username: ${uname}
SoulMarkⓈ: ${identity.soulmark}
Status: Identity Verified`;

      dashboardLink.href =
        `iascendai-dashboard.html?username=${encodeURIComponent(identity.username)}`;

      footerNav.style.display = "flex";
      dashboardLink.style.display = "inline";
      return;
    }

    // CASE B — Donation-only (no identity yet)
    if (donation) {
      resultEl.className = "verified";
      resultEl.textContent =
`Verified ✓
This SoulMarkⓈ is valid but has no identity registered yet.
SoulMarkⓈ: ${donation.soulmark}
Please create your username to activate your dashboard.`;

      footerNav.style.display = "flex";
      dashboardLink.style.display = "none";
      return;
    }

    // CASE C — No match
    resultEl.className = "invalid";
    resultEl.textContent = "❌ No matching SoulMarkⓈ found.";
    footerNav.style.display = "none";

  } catch (err) {
    resultEl.className = "invalid";
    resultEl.textContent = "⚠️ Error reaching verification service.";
    footerNav.style.display = "none";
  }
}
</script>

</body>
</html>