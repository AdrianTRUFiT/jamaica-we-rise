<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Impact Dashboard | Jamaica We Rise × iAscendAi</title>

  <!-- Loads correct backend URL -->
  <script type="module">
    import { CONFIG } from "./config.js";
    window.CONFIG = CONFIG;
  </script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(145deg, #03131f 0%, #041423 50%, #020c15 100%);
      color: #fff;
      margin: 0;
      padding: 40px 20px;
      min-height: 100vh;
      position: relative;
    }

    /* LOGOUT BUTTON */
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 6px 14px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 999px;
      color: #fff;
      cursor: pointer;
      font-size: 0.82rem;
    }

    h1 {
      text-align: center;
      font-size: 2.8em;
      background: linear-gradient(135deg, #fed103, #059c3a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    p {
      text-align: center;
      color: rgba(255,255,255,0.8);
      margin-bottom: 40px;
    }

    .stats {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 30px;
      margin-bottom: 50px;
    }

    .stat {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 30px 40px;
      text-align: center;
      min-width: 220px;
      box-shadow: 0 0 25px rgba(5,156,58,0.2);
    }

    .stat-value {
      font-size: 2.2em;
      font-weight: 800;
      color: #fed103;
    }

    .stat-label {
      color: rgba(255,255,255,0.7);
      margin-top: 10px;
      font-size: 0.95em;
    }

    h2 {
      color: #fed103;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.6em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 50px;
    }

    th, td {
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: left;
    }

    th {
      color: #fed103;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9em;
    }

    tr:hover {
      background: rgba(255,255,255,0.05);
    }

    .footer {
      text-align: center;
      color: rgba(255,255,255,0.6);
      font-size: 0.85em;
      margin-top: 40px;
    }

    .footer a {
      color: #f4a349;
      text-decoration: none;
    }

    @media (max-width: 640px) {
      h1 { font-size: 2.2em; }
      .stat { padding: 20px; min-width: 160px; }
      th, td { font-size: 0.9em; }
    }
  </style>
</head>

<body>
  <button class="logout-btn" id="logoutBtn">Logout</button>

  <h1>Impact Dashboard</h1>
  <p>Live summary of verified donations and SoulRegistryⓈ participation.</p>

  <div class="stats">
    <div class="stat">
      <div class="stat-value" id="totalRaised">$0</div>
      <div class="stat-label">Total Raised</div>
    </div>

    <div class="stat">
      <div class="stat-value" id="donorCount">0</div>
      <div class="stat-label">Total Donors</div>
    </div>

    <div class="stat">
      <div class="stat-value" id="verifiedCount">0</div>
      <div class="stat-label">Verified Identities</div>
    </div>
  </div>

  <!-- RECENT DONATIONS -->
  <div class="recent-donors">
    <h2>Recent Donations</h2>
    <table id="donorsTable">
      <thead>
        <tr><th>Display</th><th>Amount</th><th>Timestamp</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="3" style="text-align:center;color:#9ca3af;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- VERIFIED IDENTITIES -->
  <div class="verified-identities">
    <h2>Verified Identities (SoulRegistryⓈ)</h2>
    <table id="registryTable">
      <thead>
        <tr><th>Display</th><th>Username</th><th>SoulMarkⓈ</th><th>Status</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="4" style="text-align:center;color:#9ca3af;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="footer">
    <p>© 2025 Project Inside Out Jamaica × iAscendAi • Authored Intelligence</p>
    <a href="iascendai-dashboard.html">← Back to Dashboard</a>
  </div>

  <script type="module">
    import { CONFIG } from "./config.js";
    const BACKEND_URL = CONFIG.BACKEND_URL;

    // Logout
    document.getElementById("logoutBtn").onclick = () => {
      localStorage.clear();
      window.location.href = "index.html";
    };

    async function fetchRegistry() {
      const res = await fetch(`${BACKEND_URL}/registry`, { cache: "no-store" });
      return res.json();
    }

    // -------------------------
    // TOTALS
    // -------------------------
    async function loadStats() {
      const data = await fetchRegistry();
      const donations = data.filter(e => e.type === "donation");
      const identities = data.filter(e => e.type === "identity");

      const raised = donations.reduce((sum, d) => sum + (d.amount || 0), 0);
      document.getElementById("totalRaised").textContent =
        `$${raised.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;

      document.getElementById("donorCount").textContent = donations.length;
      document.getElementById("verifiedCount").textContent = identities.length;
    }

    // -------------------------
    // RECENT DONATIONS (with visibility rules)
    // -------------------------
    async function loadDonors() {
      const data = await fetchRegistry();
      const identities = data.filter(e => e.type === "identity");
      const donations = data.filter(e => e.type === "donation");

      const tbody = document.querySelector("#donorsTable tbody");

      const rows = donations.slice(-12).reverse().map(d => {
        // Match donation to identity to get display rules
        const linked = identities.find(i =>
          (i.email && i.email === d.email) ||
          (i.soulmark && i.soulmark === d.soulmark)
        );

        let displayName = "Anonymous";
        let shownAmount = `$${(d.amount || 0).toFixed(2)}`;

        if (linked) {
          // Apply identity-mode rules
          if (linked.displayIdentity === "real") {
            displayName = linked.name || "—";
          } else if (linked.displayIdentity === "anonymous") {
            displayName = "Anonymous";
          } else {
            displayName = `${linked.username}@iascendai`;
          }

          if (linked.showDonationAmount === false) {
            shownAmount = "Hidden";
          }
        }

        return `
          <tr>
            <td>${displayName}</td>
            <td>${shownAmount}</td>
            <td>${d.timestamp ? new Date(d.timestamp).toLocaleString() : "—"}</td>
          </tr>
        `;
      });

      tbody.innerHTML =
        rows.length > 0
          ? rows.join("")
          : `<tr><td colspan="3" style="text-align:center;color:#9ca3af;">No donations recorded yet.</td></tr>`;
    }

    // -------------------------
    // VERIFIED IDENTITIES TABLE
    // -------------------------
    async function loadRegistryTable() {
      const data = await fetchRegistry();
      const identities = data.filter(e => e.type === "identity");

      const tbody = document.querySelector("#registryTable tbody");

      const rows = identities.slice(-20).reverse().map(i => {
        let display = i.displayIdentity === "real"
          ? i.name
          : i.displayIdentity === "anonymous"
          ? "Anonymous"
          : `${i.username}@iascendai`;

        return `
          <tr>
            <td>${display}</td>
            <td>${i.username ? `${i.username}@iascendai` : "—"}</td>
            <td>${i.soulmark || "—"}</td>
            <td>✔ Verified</td>
          </tr>
        `;
      });

      tbody.innerHTML =
        rows.length > 0
          ? rows.join("")
          : `<tr><td colspan="4" style="text-align:center;color:#9ca3af;">No identities registered yet.</td></tr>`;
    }

    // Init
    loadStats();
    loadDonors();
    loadRegistryTable();

    // Auto-refresh every 20 seconds
    setInterval(() => {
      loadStats();
      loadDonors();
      loadRegistryTable();
    }, 20000);
  </script>

</body>
</html>