<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Support Jamaica We Rise | iAscendAi</title>

  <script src="https://js.stripe.com/v3/"></script>
  <script type="module">
    import { CONFIG } from "./config.js";
    window.CONFIG = CONFIG;
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --navy:#0a1a27;
      --navy-light:#13283b;
      --aqua:#ccf3ff;
      --text-light:#eaf8ff;
      --text-muted:#9bb3c3;

      --orange:#f7a541;
      --orange-bright:#ff7c3e;
      --orange-lite:#ffb774;

      --glass:rgba(255,255,255,0.08);
    }

    body {
      font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--navy) 0%, #051019 100%);
      min-height:100vh;
      padding:30px 20px;
      color:white;
    }

    .container { max-width: 720px; margin:0 auto; }

    .header {
      text-align:center;
      margin-bottom:35px;
    }

    .site-title {
      font-size:2.6rem;
      font-weight:750;
      color:var(--aqua);
      margin-bottom:8px;
      letter-spacing:1px;
    }

    .tagline {
      font-size:1.1rem;
      color:var(--aqua);
      opacity:.85;
      letter-spacing:.5px;
    }

    .donation-card {
      background: var(--glass);
      backdrop-filter: blur(16px);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:24px;
      padding:38px;
      box-shadow:0 18px 45px rgba(0,0,0,0.35);
    }

    .title {
      font-size:2rem;
      font-weight:700;
      color:var(--aqua);
      margin-bottom:10px;
      text-align:center;
    }

    .subtitle {
      text-align:center;
      color:var(--text-muted);
      font-size:1rem;
      margin-bottom:28px;
      line-height:1.6;
    }

    .impact-stats {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:20px;
      margin-bottom:30px;
      padding:18px;
      background: rgba(255,255,255,0.06);
      border-radius:18px;
    }
    .stat-value {
      font-size:1.6rem;
      font-weight:700;
      color:var(--orange-lite);
      text-align:center;
    }
    .stat-label {
      font-size:.85rem;
      color:var(--text-muted);
      text-align:center;
      margin-top:4px;
    }

    label {
      display:block;
      font-weight:600;
      margin-bottom:8px;
      color:var(--aqua);
      font-size:.95rem;
    }

    input {
      width:100%;
      padding:14px 16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.08);
      color:white;
      font-size:1rem;
    }
    input::placeholder { color:rgba(255,255,255,0.35); }

    .form-group { margin-bottom:20px; }

    .amount-options {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }

    .amount-btn {
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.05);
      color:var(--aqua);
      font-size:1.1rem;
      font-weight:600;
      cursor:pointer;
      transition:.25s ease;
    }
    .amount-btn:hover { background:rgba(255,255,255,0.15); }
    .amount-btn.selected {
      background:linear-gradient(135deg,var(--orange),var(--orange-bright));
      border:none;
      color:white;
    }

    .submit-btn {
      width:100%;
      padding:16px;
      border:none;
      border-radius:14px;
      background:linear-gradient(135deg,var(--orange),var(--orange-bright));
      color:white;
      font-weight:700;
      font-size:1.15rem;
      cursor:pointer;
      box-shadow:0 12px 25px rgba(0,0,0,0.35);
      margin-top:10px;
      transition:.28s ease;
    }
    .submit-btn:hover {
      transform:translateY(-2px);
      box-shadow:0 18px 35px rgba(0,0,0,0.45);
    }
    .submit-btn:disabled { opacity:.6; transform:none; }

    .footer {
      text-align:center;
      margin-top:35px;
      color:var(--text-muted);
      font-size:.9rem;
    }
    .footer a {
      color:var(--orange-lite);
      text-decoration:none;
      font-weight:600;
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="header">
      <div class="site-title">iAscendAi</div>
      <div class="tagline">Verify Digital Identities + Verified Transactions</div>
    </div>

    <div class="donation-card">

      <div class="title">Jamaica We Rise Relief Fund</div>
      <div class="subtitle">
        Every donation supports families affected by Hurricane Melissa.  
        Your contribution is authenticated using SoulMark‚ìà verification.
      </div>

      <div class="impact-stats">
        <div>
          <div class="stat-value" id="donorCount">0</div>
          <div class="stat-label">Donors</div>
        </div>
        <div>
          <div class="stat-value" id="totalRaised">$0</div>
          <div class="stat-label">Raised</div>
        </div>
        <div>
          <div class="stat-value" id="goalPercent">0%</div>
          <div class="stat-label">Goal Progress</div>
        </div>
      </div>

      <form id="donationForm">

        <div class="form-group">
          <label>Full Name *</label>
          <input id="name" type="text" required placeholder="Adrian McKenzie" />
        </div>

        <div class="form-group">
          <label>Email Address *</label>
          <input id="email" type="email" required placeholder="you@example.com" />
        </div>

        <label>Select Amount *</label>
        <div class="amount-options form-group">
          <button type="button" class="amount-btn" data-amount="25">$25</button>
          <button type="button" class="amount-btn" data-amount="50">$50</button>
          <button type="button" class="amount-btn" data-amount="100">$100</button>
          <button type="button" class="amount-btn" data-amount="250">$250</button>
          <button type="button" class="amount-btn" data-amount="500">$500</button>
          <button type="button" class="amount-btn" data-amount="custom">Custom</button>
        </div>

        <div class="form-group" id="customAmountRow" style="display:none;">
          <label>Custom Amount ($)</label>
          <input id="customAmount" type="number" min="1" step="1" />
        </div>

        <button type="submit" id="submitBtn" class="submit-btn">
          Donate Now ‚Äî SoulMark‚ìà Verified
        </button>

        <div id="status" style="margin-top:15px;text-align:center;color:var(--text-muted);font-weight:600;"></div>

      </form>
    </div>

    <div class="footer">
      View live impact: <a href="/impact.html">Impact Dashboard</a>
    </div>

  </div>

  <!-- FULL JAVASCRIPT -->
  <script type="module">
    import { CONFIG } from "./config.js";
    const BACKEND_URL = CONFIG.BACKEND_URL;

    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const statusEl = document.getElementById("status");
    const donorCountEl = document.getElementById("donorCount");
    const totalRaisedEl = document.getElementById("totalRaised");
    const goalPercentEl = document.getElementById("goalPercent");
    const amountButtons = document.querySelectorAll(".amount-btn");
    const customAmountRow = document.getElementById("customAmountRow");
    const customInput = document.getElementById("customAmount");
    const submitBtn = document.getElementById("submitBtn");

    let selectedAmount = null;
    let soulmark = null;

    /* -------- LIVE DONATION STATS -------- */
    async function loadStats(){
      try{
        const res = await fetch(`${BACKEND_URL}/donations/stats`, {cache:"no-store"});
        if(!res.ok) return;

        const data = await res.json();
        donorCountEl.textContent = data.donorCount || 0;

        totalRaisedEl.textContent = `$${(data.totalRaised || 0).toLocaleString()}`;

        const GOAL = 50000;
        goalPercentEl.textContent =
          Math.round(((data.totalRaised || 0) / GOAL) * 100) + "%";
      }catch(err){}
    }
    loadStats();
    setInterval(loadStats, 30000);

    /* -------- SOULMARK VERIFY ON EMAIL -------- */
    emailInput.addEventListener("blur", async () => {
      const email = emailInput.value.trim();
      if(!email) return;

      statusEl.textContent = "üîç Verifying SoulMark‚ìà...";
      statusEl.style.color = "#9bb3c3";

      try{
        const res = await fetch(`${BACKEND_URL}/verify-soulmark`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({email})
        });
        const data = await res.json();

        if(data.verified && data.soulmark){
          soulmark = data.soulmark;
          statusEl.textContent = `‚úì SoulMark‚ìà Verified`;
          statusEl.style.color = "lightgreen";
        } else {
          statusEl.textContent = "‚ö†Ô∏è No SoulMark found ‚Äî will be created on donation.";
          soulmark = null;
          statusEl.style.color = "orange";
        }
      }catch(err){
        statusEl.textContent = "‚ö†Ô∏è Could not verify SoulMark‚ìà";
        statusEl.style.color = "red";
      }
    });

    /* -------- AMOUNT BUTTONS -------- */
    amountButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        amountButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");

        if(btn.dataset.amount === "custom"){
          customAmountRow.style.display = "block";
          customInput.focus();
          selectedAmount = null;
        } else {
          customAmountRow.style.display = "none";
          selectedAmount = Number(btn.dataset.amount);
        }
      });
    });

    /* -------- DONATION SUBMIT -------- */
    document.getElementById("donationForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const custom = Number(customInput.value) || 0;
      const amount = selectedAmount || custom;

      if(!name || !email){
        statusEl.textContent = "Please enter name and email.";
        statusEl.style.color = "red";
        return;
      }

      if(!amount || amount < 1){
        statusEl.textContent = "Please select or enter an amount.";
        statusEl.style.color = "red";
        return;
      }

      statusEl.textContent = "Creating Stripe session...";
      submitBtn.disabled = true;

      try{
        const res = await fetch(`${BACKEND_URL}/create-checkout-session`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({name, email, amount, soulmark})
        });

        const data = await res.json();
        if(!data.url){
          throw new Error("Invalid Stripe response");
        }

        statusEl.textContent = "Redirecting to Stripe‚Ä¶";
        statusEl.style.color = "lightgreen";

        setTimeout(()=>window.location.href=data.url, 600);

      }catch(err){
        statusEl.textContent = "‚ö†Ô∏è Could not reach server.";
        statusEl.style.color = "red";
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
