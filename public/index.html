<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jamaica We Rise Relief Fund</title>

<script type="module">
import { CONFIG } from "./config.js";
window.CONFIG = CONFIG;
</script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: Inter, sans-serif;
  background: radial-gradient(circle at top, #0f172a, #020617 40%, #000814);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  padding: 24px;
  color: #e5f2ff;
}

.card {
  width: 100%;
  max-width: 600px;
  background: rgba(11, 25, 45, 0.9);
  border-radius: 24px;
  padding: 32px;
  border: 1px solid rgba(148,163,184,0.35);
  margin-top: 32px;
}

h1 {
  font-size: 2rem;
  font-weight: 800;
  text-align: center;
  background: linear-gradient(120deg, #b8edee, #fed103);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 12px;
}

.subtitle {
  text-align: center;
  color: #9ca3af;
  margin-bottom: 18px;
  font-size: 1rem;
}

.identity-banner {
  margin-bottom: 18px;
  font-size: 0.9rem;
  padding: 10px 12px;
  border-radius: 999px;
  background: rgba(15,23,42,0.95);
  border: 1px solid rgba(34,197,94,0.5);
  color: #bbf7d0;
  display: none;
  text-align: center;
}

.identity-banner span.handle {
  font-weight: 700;
  color: #a5f3fc;
}

label {
  font-size: 0.95rem;
  margin-bottom: 6px;
  display: block;
  color: #cbd5e1;
}

input {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  background: rgba(15,23,42,0.95);
  border: 1px solid rgba(148,163,184,0.4);
  color: #e5f2ff;
  font-size: 1rem;
  margin-bottom: 20px;
}

input[readonly] {
  opacity: 0.9;
  cursor: not-allowed;
  background: rgba(15,23,42,0.85);
}

.amount-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.amount-btn {
  padding: 14px 0;
  border-radius: 12px;
  background: rgba(15,23,42,0.95);
  border: 1px solid rgba(148,163,184,0.35);
  color: #e5f2ff;
  text-align: center;
  font-size: 1rem;
  cursor: pointer;
  transition: 0.2s ease;
}

.amount-btn.active {
  background: linear-gradient(135deg, #f4a349, #fed103);
  color: #041423;
  font-weight: 700;
}

button {
  width: 100%;
  margin-top: 24px;
  padding: 16px;
  border-radius: 999px;
  background: linear-gradient(135deg, #f4a349, #fed103);
  border: none;
  font-weight: 800;
  color: #041423;
  cursor: pointer;
  font-size: 1rem;
  box-shadow: 0 20px 45px rgba(0,0,0,0.55);
}

.footer-link {
  margin-top: 24px;
  text-align: center;
  font-size: 0.95rem;
  color: #fed103;
}

.footer-link a {
  color: #fed103;
  font-weight: 600;
  text-decoration: none;
}

</style>
</head>

<body>

<div class="card">
<h1>Jamaica We Rise Relief Fund</h1>

<p class="subtitle">
  Every donation supports families affected by Hurricane Melissa.<br>
  Your contribution is authenticated using SoulMarkⓈ verification.
</p>

<div id="identityBanner" class="identity-banner">
  Donating as <span class="handle" id="identityHandle"></span>.
  Identity verified.
</div>

<label>Full Name *</label>
<input id="fullName" placeholder="Adrian McKenzie" autocomplete="name" />

<label>Email Address *</label>
<input id="email" type="email" placeholder="you@example.com" autocomplete="email" />

<label>Select Amount *</label>
<div class="amount-grid">
  <div class="amount-btn" data-value="25">$25</div>
  <div class="amount-btn" data-value="50">$50</div>
  <div class="amount-btn" data-value="100">$100</div>

  <div class="amount-btn" data-value="250">$250</div>
  <div class="amount-btn" data-value="500">$500</div>
  <div class="amount-btn" data-value="custom">Custom</div>
</div>

<input id="customAmount" placeholder="Enter custom amount" style="display:none;" />

<button id="donateBtn">Donate Now — SoulMarkⓈ Verified</button>

<div class="footer-link">
  View live impact: <a href="impact-dashboard.html">Impact Dashboard</a>
</div>

</div>

<script type="module">
import { CONFIG } from "./config.js";
const BACKEND_URL = CONFIG.BACKEND_URL;

const nameInput = document.getElementById("fullName");
const emailInput = document.getElementById("email");
const banner = document.getElementById("identityBanner");
const handle = document.getElementById("identityHandle");
const customAmount = document.getElementById("customAmount");

let selectedAmount = null;

// ------------------------------------------------
// 1. SECURE IDENTITY HYDRATION
// ------------------------------------------------
async function hydrateIdentity() {
  const emailLS = (localStorage.getItem("email") || "").toLowerCase().trim();
  const usernameLS = localStorage.getItem("username") || "";
  const nameLS = localStorage.getItem("name") || "";

  if (!emailLS) return;

  try {
    const res = await fetch(`${BACKEND_URL}/verify-identity`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: emailLS })
    });
    const data = await res.json();

    if (data.valid) {
      banner.style.display = "block";
      handle.textContent = `${data.username}@iascendai`;

      nameInput.value = data.name;
      emailInput.value = emailLS;

      nameInput.readOnly = true;
      emailInput.readOnly = true;
    }
  } catch (err) {
    console.warn("Identity hydration failed", err);
  }
}

hydrateIdentity();

// ------------------------------------------------
// 2. AMOUNT BUTTON LOGIC
// ------------------------------------------------
document.querySelectorAll(".amount-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".amount-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    if (btn.dataset.value === "custom") {
      customAmount.style.display = "block";
      selectedAmount = null;
    } else {
      customAmount.style.display = "none";
      selectedAmount = parseFloat(btn.dataset.value);
    }
  });
});

// ------------------------------------------------
// 3. DONATE → STRIPE SESSION
// ------------------------------------------------
document.getElementById("donateBtn").onclick = async () => {
  const name = nameInput.value.trim();
  const email = emailInput.value.toLowerCase().trim();

  let amount = selectedAmount;
  if (!amount) {
    const raw = customAmount.value.trim();
    if (raw) amount = parseFloat(raw);
  }

  if (!name || !email || !Number.isFinite(amount) || amount <= 0) {
    alert("Please complete all fields with valid information.");
    return;
  }

  localStorage.setItem("name", name);
  localStorage.setItem("email", email);

  try {
    const res = await fetch(`${BACKEND_URL}/create-checkout-session`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email, amount })
    });

    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("Error creating checkout session.");
    }
  } catch (err) {
    console.error(err);
    alert("Connection issue. Try again.");
  }
};
</script>

</body>
</html>