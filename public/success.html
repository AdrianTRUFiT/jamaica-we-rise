<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donation Successful | Jamaica We Rise × iAscendAi</title>

  <script type="module">
    import { CONFIG } from "./config.js";
    window.CONFIG = CONFIG;
  </script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Inter, sans-serif;
      background: radial-gradient(circle at top, #0f172a, #020617 40%, #000814);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
      color: #e5f2ff;
    }

    .card {
      width: 100%;
      max-width: 600px;
      background: rgba(11, 25, 45, 0.9);
      border-radius: 24px;
      padding: 32px;
      border: 1px solid rgba(148,163,184,0.35);
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(120deg, #b8edee, #fed103);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 12px;
    }

    .subtitle {
      text-align: center;
      color: #9ca3af;
      margin-bottom: 28px;
      font-size: 0.95rem;
    }

    .label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .value-box {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.35);
      margin-bottom: 16px;
      font-size: 1rem;
      font-weight: 600;
      color: #e5f2ff;
      word-break: break-all;
    }

    button {
      width: 100%;
      margin-top: 24px;
      padding: 16px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f4a349, #fed103);
      border: none;
      font-weight: 800;
      color: #041423;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 20px 45px rgba(0,0,0,0.55);
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Donation Successful</h1>

    <p class="subtitle">
      Thank you for supporting Jamaica We Rise.<br>
      Verifying your donation and linking your iAscendAi identity…
    </p>

    <div>
      <div class="label">Amount</div>
      <div id="amountBox" class="value-box">$—</div>

      <div class="label">Email</div>
      <div id="emailBox" class="value-box">Loading…</div>

      <div class="label">SoulMarkⓈ Hash</div>
      <div id="soulBox" class="value-box" style="font-size:0.85rem">Loading…</div>
    </div>

    <div id="errorBox" style="margin-top:12px;color:#ff6b6b;font-size:.9rem;display:none;">
      ⚠️ We could not verify your donation. Please refresh the page.
    </div>

    <button id="continueBtn">Continue to Create Your Identity</button>
  </div>

  <script type="module">
    import { CONFIG } from "./config.js";
    const BACKEND_URL = CONFIG.BACKEND_URL;

    // Capture query params from JS-delivered redirect (Stripe → Vercel)
    const params = new URLSearchParams(window.location.search);
    let sessionId = params.get("session_id");

    console.log("Initial session_id:", sessionId);

    // Retry logic for Safari/Vercel parameter delay bug
    if (!sessionId) {
      setTimeout(() => {
        const retryId = new URLSearchParams(window.location.search).get("session_id");
        console.log("Retry session_id:", retryId);
        if (retryId) {
          sessionId = retryId;
          loadSession();
        }
      }, 600);
    }

    async function loadSession() {
      if (!sessionId) return; // Avoid premature call

      try {
        const res = await fetch(
          `${BACKEND_URL}/retrieve-session?session_id=${encodeURIComponent(sessionId)}`
        );

        const data = await res.json();
        console.log("Session Data:", data);

        if (!data || !data.email) {
          throw new Error("Invalid Stripe session data");
        }

        const amount = data.amount;
        const email  = data.email;
        const soul   = data.soulmark;

        document.getElementById("amountBox").textContent =
          amount ? `$${amount.toFixed(2)}` : "$—";

        document.getElementById("emailBox").textContent = email || "Not available";
        document.getElementById("soulBox").textContent  = soul || "Not assigned";

        // Save for registration
        localStorage.setItem("donation_amount", amount || "");
        localStorage.setItem("donor_email", email || "");
        localStorage.setItem("donor_soulmark", soul || "");

      } catch (err) {
        console.error("Error retrieving session:", err);
        document.getElementById("errorBox").style.display = "block";
      }
    }

    // Start initial load
    if (sessionId) loadSession();

    document.getElementById("continueBtn").onclick = () => {
      const email  = localStorage.getItem("donor_email") || "";
      const soul   = localStorage.getItem("donor_soulmark") || "";
      const amount = localStorage.getItem("donation_amount") || "";

      window.location.href =
        `/iascendai-register.html?email=${encodeURIComponent(email)}&soulmark=${encodeURIComponent(soul)}&amount=${encodeURIComponent(amount)}`;
    };
  </script>
</body>
</html>